{"ast":null,"code":"import { SET_AUTH_DATA, WS_FOLLOW, setWsActionCreator } from '../reducers/authReducer.js';\nimport { WS_MESSAGE, READ_MESSAGES, getDialog, getDialogs, getDialogsWithoutToggle } from '../reducers/messagesReducer.js';\nimport { SEND_YOU_MESSAGE, FOLLOW_YOU, LIKE_YOUR_POST, addNotification } from '../reducers/notifi.js';\nimport { SET_LIKES_POST } from '../reducers/profileReducer.js';\nimport { host } from '../api/api.js';\nconst SEND_MESSAGE = 'SEND-MESSAGE';\n\nconst ws = store => next => action => {\n  let result = next(action);\n  let state = store.getState();\n\n  const startWebSocketConnection = () => {\n    let ws = new WebSocket(`ws://${host}:8181`);\n\n    ws.onopen = e => {\n      store.dispatch(setWsActionCreator(ws));\n      ws.send(JSON.stringify({\n        token: state.auth.token,\n        id: state.auth.id,\n        action: 'AUTH'\n      }));\n    };\n\n    ws.onclose = event => {\n      if (event.wasClean) {\n        alert(`[close] Соединение закрыто чисто, код=${event.code} причина=${event.reason}`);\n      } else {\n        setTimeout(startWebSocketConnection(), 2000);\n      }\n    };\n\n    ws.onmessage = event => {\n      state = store.getState(); //console.log(event);\n\n      let data = JSON.parse(event.data); //console.log(data);\n      //let {id, token, dialog_id} = options;\n      //alert(`[message] Данные получены с сервера: ${event.data}`);\n\n      let options = {};\n\n      switch (data.action) {\n        case SEND_MESSAGE:\n          //console.log(state);\n          options = {\n            id: state.auth.id,\n            token: state.auth.token\n          };\n\n          if (state.messagesPage.dialogs.find(dialog => dialog.user_id == data.id)) {\n            let url = document.location.href;\n\n            if (Object.keys(state.messagesPage.dialog).length && ~url.lastIndexOf(state.messagesPage.dialog.dialog_id) && state.messagesPage.dialog.user_id === data.id) {\n              let dialog_id = state.messagesPage.dialogs.find(dialog => dialog.user_id == data.id).dialog_id;\n              options.dialog_id = dialog_id;\n              store.dispatch(getDialog(options));\n            } else {\n              //let {id, token, user_id} = options;\n              //data.id, SEND_YOU_MESSAGE\n              options = {\n                id: state.auth.id,\n                token: state.auth.token,\n                user_id: data.id\n              };\n              store.dispatch(addNotification(options, SEND_YOU_MESSAGE));\n            }\n\n            store.dispatch(getDialogsWithoutToggle(options));\n          } else {\n            store.dispatch(getDialogs(options)).then(res => {\n              state = store.getState();\n              let dialog_id = state.messagesPage.dialogs.find(dialog => dialog.user_id == data.id).dialog_id;\n              options.dialog_id = dialog_id;\n              store.dispatch(getDialog(options));\n            });\n          }\n\n          break;\n\n        case READ_MESSAGES:\n          //alert('new mess');\n          if (state.messagesPage.dialog.dialog_id === data.dialog_id) {\n            options = {\n              id: state.auth.id,\n              token: state.auth.token,\n              dialog_id: data.dialog_id\n            };\n            store.dispatch(getDialog(options));\n          }\n\n          ;\n          break;\n\n        case WS_FOLLOW:\n          options = {\n            id: state.auth.id,\n            token: state.auth.token,\n            user_id: data.id\n          };\n          store.dispatch(addNotification(options, FOLLOW_YOU));\n          break;\n\n        case SET_LIKES_POST:\n          options = {\n            id: state.auth.id,\n            token: state.auth.token,\n            user_id: data.id\n          };\n          store.dispatch(addNotification(options, LIKE_YOUR_POST));\n          break;\n      }\n\n      ;\n    };\n  };\n\n  let data = '';\n  let user_id = '';\n\n  switch (action.type) {\n    case SET_AUTH_DATA:\n      //console.log(SET_AUTH_DATA);\n      startWebSocketConnection();\n      break;\n\n    case WS_MESSAGE:\n      data = JSON.stringify({\n        id: state.auth.id,\n        action: 'SEND-MESSAGE',\n        user_id: action.user_id\n      });\n      state.auth.ws.send(data);\n      break;\n\n    case READ_MESSAGES:\n      data = JSON.stringify({\n        id: state.auth.id,\n        action: READ_MESSAGES,\n        user_id: state.messagesPage.dialog.user_id,\n        dialog_id: state.messagesPage.currentDialog\n      });\n      state.auth.ws.send(data);\n      break;\n\n    case WS_FOLLOW:\n      data = JSON.stringify({\n        id: state.auth.id,\n        action: action.type,\n        user_id: action.user_id\n      });\n      state.auth.ws.send(data);\n      break;\n\n    case SET_LIKES_POST:\n      let routs = action.post.picture.split('/').filter(rout => rout != '');\n      user_id = routs[routs.indexOf('profile') + 1];\n\n      if (user_id != state.auth.id && action.post.likes.includes(state.auth.id)) {\n        data = JSON.stringify({\n          id: state.auth.id,\n          action: action.type,\n          user_id,\n          post_id: action.post.id\n        });\n        state.auth.ws.send(data);\n      }\n\n      break;\n  }\n\n  return result;\n};\n\nexport default ws;","map":{"version":3,"sources":["/root/Documents/projects/social-network/src/middleware/ws.js"],"names":["SET_AUTH_DATA","WS_FOLLOW","setWsActionCreator","WS_MESSAGE","READ_MESSAGES","getDialog","getDialogs","getDialogsWithoutToggle","SEND_YOU_MESSAGE","FOLLOW_YOU","LIKE_YOUR_POST","addNotification","SET_LIKES_POST","host","SEND_MESSAGE","ws","store","next","action","result","state","getState","startWebSocketConnection","WebSocket","onopen","e","dispatch","send","JSON","stringify","token","auth","id","onclose","event","wasClean","alert","code","reason","setTimeout","onmessage","data","parse","options","messagesPage","dialogs","find","dialog","user_id","url","document","location","href","Object","keys","length","lastIndexOf","dialog_id","then","res","type","currentDialog","routs","post","picture","split","filter","rout","indexOf","likes","includes","post_id"],"mappings":"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","sourcesContent":["import {SET_AUTH_DATA, WS_FOLLOW, setWsActionCreator} from '../reducers/authReducer.js';\nimport {WS_MESSAGE, READ_MESSAGES, getDialog, getDialogs, getDialogsWithoutToggle} from '../reducers/messagesReducer.js';\nimport {SEND_YOU_MESSAGE, FOLLOW_YOU, LIKE_YOUR_POST, addNotification} from '../reducers/notifi.js';\nimport {SET_LIKES_POST} from '../reducers/profileReducer.js';\nimport {host} from '../api/api.js';\n\nconst SEND_MESSAGE = 'SEND-MESSAGE';\n\n\nconst ws = store => next => action => {\n\n  let result = next(action);\n\n  let state = store.getState();\n\n  const startWebSocketConnection = () => {\n    let ws = new WebSocket(`ws://${host}:8181`);\n    ws.onopen = (e) => {\n      store.dispatch(setWsActionCreator(ws));\n      ws.send(JSON.stringify({\n        token: state.auth.token,\n        id: state.auth.id,\n        action: 'AUTH',\n      }));\n    };\n\n    ws.onclose = (event) => {\n      if (event.wasClean) {\n        alert(`[close] Соединение закрыто чисто, код=${event.code} причина=${event.reason}`);\n      } else {\n        setTimeout(startWebSocketConnection(), 2000);\n      }\n    };\n\n    ws.onmessage = (event) => {\n      state = store.getState();\n      //console.log(event);\n      let data = JSON.parse(event.data);\n      //console.log(data);\n      //let {id, token, dialog_id} = options;\n      //alert(`[message] Данные получены с сервера: ${event.data}`);\n      let options = {};\n      switch(data.action) {\n        case SEND_MESSAGE:\n\n          //console.log(state);\n          options = {\n            id: state.auth.id,\n            token: state.auth.token,\n          };\n\n          if(state.messagesPage.dialogs.find(dialog => dialog.user_id == data.id)){\n            let url = document.location.href;\n            if( Object.keys(state.messagesPage.dialog).length\n              && ~url.lastIndexOf(state.messagesPage.dialog.dialog_id)\n              && state.messagesPage.dialog.user_id === data.id ) {\n\n              let dialog_id = state.messagesPage.dialogs\n                .find(dialog => dialog.user_id == data.id).dialog_id;\n              options.dialog_id = dialog_id;\n              store.dispatch(getDialog(options));\n\n            } else {\n              //let {id, token, user_id} = options;\n              //data.id, SEND_YOU_MESSAGE\n              options = {\n                id: state.auth.id,\n                token: state.auth.token,\n                user_id: data.id,\n              };\n              store.dispatch(addNotification(options, SEND_YOU_MESSAGE));\n            }\n            store.dispatch(getDialogsWithoutToggle(options))\n          } else {\n            store.dispatch(getDialogs(options))\n              .then(res => {\n                state = store.getState();\n                let dialog_id = state.messagesPage.dialogs\n                  .find(dialog => dialog.user_id == data.id).dialog_id;\n                options.dialog_id = dialog_id;\n                store.dispatch(getDialog(options));\n              });\n          }\n          break;\n        case READ_MESSAGES:\n          //alert('new mess');\n          if(state.messagesPage.dialog.dialog_id === data.dialog_id) {\n            options = {\n              id: state.auth.id,\n              token: state.auth.token,\n              dialog_id: data.dialog_id,\n            };\n            store.dispatch(getDialog(options));\n          };\n          break;\n        case WS_FOLLOW:\n          options = {\n            id: state.auth.id,\n            token: state.auth.token,\n            user_id: data.id,\n          };\n          store.dispatch(addNotification(options, FOLLOW_YOU));\n\n          break;\n        case SET_LIKES_POST:\n          options = {\n            id: state.auth.id,\n            token: state.auth.token,\n            user_id: data.id,\n          };\n          store.dispatch(addNotification(options, LIKE_YOUR_POST));\n\n          break;\n\n      };\n    };\n  }\n\n  let data = '';\n  let user_id = '';\n\n  switch(action.type) {\n    case SET_AUTH_DATA:\n      //console.log(SET_AUTH_DATA);\n      startWebSocketConnection();\n      break;\n    case WS_MESSAGE:\n      data = JSON.stringify({\n        id: state.auth.id,\n        action: 'SEND-MESSAGE',\n        user_id: action.user_id,\n      });\n      state.auth.ws.send(data);\n      break;\n    case READ_MESSAGES:\n      data = JSON.stringify({\n        id: state.auth.id,\n        action: READ_MESSAGES,\n        user_id: state.messagesPage.dialog.user_id,\n        dialog_id: state.messagesPage.currentDialog,\n      });\n      state.auth.ws.send(data);\n      break;\n    case WS_FOLLOW:\n      data = JSON.stringify({\n        id: state.auth.id,\n        action: action.type,\n        user_id: action.user_id,\n      });\n      state.auth.ws.send(data);\n      break;\n    case SET_LIKES_POST:\n      let routs = action.post.picture.split('/').filter(rout => rout != '');\n      user_id = routs[routs.indexOf('profile') + 1];\n      if(user_id != state.auth.id && action.post.likes.includes(state.auth.id)) {\n        data = JSON.stringify({\n          id: state.auth.id,\n          action: action.type,\n          user_id,\n          post_id: action.post.id,\n        });\n        state.auth.ws.send(data);\n      }\n      break;\n  }\n\n  return result;\n}\n\nexport default ws;\n"]},"metadata":{},"sourceType":"module"}